# Prisma Setup Guide

Step-by-step guide for setting up and using Prisma in the DSA Solver project.

## Initial Setup (First Time)

### Step 1: Install Dependencies

```bash
npm install
```

**Why:** Installs Prisma CLI and all required packages.

### Step 2: Set Up Database Connection

Create `.env` file in root directory:

**For Local PostgreSQL:**
```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/postgres?schema=public
```

**For Docker:**
```env
DATABASE_URL=postgresql://postgres:postgres@postgres:5435/postgres?schema=public
```

**Why:** Prisma needs the database connection string to connect to PostgreSQL.

### Step 3: Start Database (If Using Docker)

```bash
npm run docker:up
```

**Why:** Starts PostgreSQL container. Wait until it's healthy before proceeding.

### Step 4: Define Your Schema

Edit `prisma/schema.prisma` and add your models:

```prisma
generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Example: Add your models here
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**Why:** Schema defines your database structure. Prisma uses this to generate types and migrations.

### Step 5: Create and Apply Migration

```bash
npm run prisma:migrate
```

When prompted, enter a migration name (e.g., `init`).

**What it does:**
- Creates SQL migration file in `prisma/migrations/`
- Applies changes to your database
- Generates Prisma Client automatically

**Why:** Migrations track database changes over time. This creates your initial database structure.

### Step 6: Generate Prisma Client (If Needed)

```bash
npm run prisma:generate
```

**What it does:** Generates TypeScript types and client in `lib/generated/prisma/`

**Why:** You need the Prisma Client to query your database in code. Usually auto-generated by migrate, but run this if you change schema without migrating.

## Daily Development Workflow

### Making Schema Changes

**Step 1:** Edit `prisma/schema.prisma` (add models, fields, relations)

**Step 2:** Create migration:
```bash
npm run prisma:migrate
```
Enter descriptive name (e.g., `add_task_model`, `add_user_phone`)

**Why:** Creates a migration file that can be version controlled and applied to other environments.

**Step 3:** Use in your code:
```typescript
import prisma from "@/lib/prisma-client";

const users = await prisma.user.findMany();
```

## Available Commands

### `npm run prisma:generate`

**What:** Generates Prisma Client from schema

**When to use:**
- After pulling code with schema changes
- After manually editing schema
- When types are missing in your IDE

**Why:** Prisma Client is generated code that provides type-safe database access.

---

### `npm run prisma:migrate`

**What:** Creates a new migration and applies it

**When to use:**
- After changing `schema.prisma`
- When you need to update database structure

**Why:** 
- Creates migration file (version control)
- Applies changes to database
- Regenerates Prisma Client

**Note:** Prompts for migration name - use descriptive names like `add_user_table`, `add_email_index`

---

### `npm run prisma:migrate:deploy`

**What:** Applies all pending migrations (doesn't create new ones)

**When to use:**
- In production/staging environments
- When you pulled code with new migrations
- To sync database with latest migrations

**Why:** In production, you only apply existing migrations, not create new ones.

---

### `npm run prisma:migrate:reset`

**What:** Drops database, recreates it, and applies all migrations

**When to use:**
- Development only
- When you want a fresh start
- After major schema changes

**Why:** ⚠️ **Deletes all data!** Useful for development when you want to start clean.

---

### `npm run prisma:studio`

**What:** Opens visual database browser at http://localhost:5555

**When to use:**
- View database data
- Test queries visually
- Debug data issues

**Why:** Provides a GUI to browse and edit database without writing SQL.

---

### `npm run prisma:seed`

**What:** Runs seed script to populate database with initial data

**When to use:**
- After resetting database
- Setting up development environment
- Adding test data

**Why:** Seeds provide consistent initial data for development/testing.

**Setup:** Edit `prisma/seed/seed.ts` to define your seed data.

---

### `npm run prisma:format`

**What:** Auto-formats `schema.prisma` file

**When to use:**
- Before committing schema changes
- When schema looks messy

**Why:** Keeps schema file clean and readable.

---

### `npm run prisma:validate`

**What:** Checks if schema is valid (doesn't apply changes)

**When to use:**
- Before creating migration
- To check for syntax errors

**Why:** Catches errors early without affecting database.

## Common Scenarios

### Scenario 1: Adding a New Model

1. Edit `prisma/schema.prisma`:
```prisma
model Task {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
}
```

2. Run migration:
```bash
npm run prisma:migrate
# Name: add_task_model
```

3. Use in code:
```typescript
const task = await prisma.task.create({
  data: { title: "My Task" }
});
```

### Scenario 2: Adding a Field

1. Edit schema:
```prisma
model User {
  // ... existing fields
  phone String? // Add this
}
```

2. Run migration:
```bash
npm run prisma:migrate
# Name: add_user_phone
```

### Scenario 3: Adding Relations

1. Edit schema:
```prisma
model User {
  id    String  @id @default(cuid())
  tasks Task[]  // Add relation
}

model Task {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])
}
```

2. Run migration:
```bash
npm run prisma:migrate
# Name: add_user_task_relation
```

## Quick Reference

| Task | Command |
|------|---------|
| First time setup | `npm run docker:up` → Edit schema → `npm run prisma:migrate` |
| Change schema | Edit schema → `npm run prisma:migrate` |
| View database | `npm run prisma:studio` |
| Reset database | `npm run prisma:migrate:reset` |
| Seed data | `npm run prisma:seed` |
| Check schema | `npm run prisma:validate` |

## Important Notes

1. **Always use migrations** - Never edit database directly
2. **Descriptive names** - Use clear migration names (e.g., `add_user_email_index`)
3. **Test locally first** - Always test migrations before production
4. **Version control migrations** - Commit migration files to git
5. **Reset is destructive** - `prisma:migrate:reset` deletes all data

## Troubleshooting

**Migration conflicts?**
```bash
npm run prisma:migrate:reset  # Development only
```

**Client not generated?**
```bash
npm run prisma:generate
```

**Database connection error?**
- Check `.env` DATABASE_URL
- Verify database is running: `docker-compose ps`
- Test connection: `npx prisma db pull`
